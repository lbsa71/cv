<html>
  <head>
    <title>CV Data Upload</title>
    <!-- Include jszip and jspdf from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
      import { generateCV } from '../services/pdf/pdfGenerator';

      // Function to parse CSV data
      function parseCSV(text) {
        console.log('Parsing CSV data');
        const rows = text.split('\n');
        const headers = rows[0].split(',');
        return rows.slice(1).map(row => {
          const values = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
          return headers.reduce((obj, header, index) => {
            obj[header] = values[index] ? values[index].replace(/(^"|"$)/g, '') : '';
            return obj;
          }, {});
        });
      }

      // Function to handle file upload and processing
      async function handleFileUploadAndProcess() {
        console.log('Handling file upload');
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) {
          console.error('No file selected');
          return;
        }

        const zip = new JSZip();
        const zipContent = await zip.loadAsync(file);
        const data = {};

        for (const fileName of Object.keys(zipContent.files)) {
          console.log('Processing file:', fileName);
          if (fileName.endsWith('.csv')) {
            const fileData = await zipContent.files[fileName].async('text');
            data[fileName] = parseCSV(fileData);
          } else if (fileName.endsWith('.jpg') || fileName.endsWith('.png')) {
            const imageData = await zipContent.files[fileName].async('base64');
            data.image = `data:image/jpeg;base64,${imageData}`;
          }
        }

        console.log('Data processed:', data);
        // Call the generateCV function from pdfGenerator.ts here
        generateCV(data);
      }

      window.handleFileUploadAndProcess = handleFileUploadAndProcess;
    </script>
  </head>
  <body>
    <h1>Upload and Process CV Data</h1>
    <input type="file" accept=".zip" id="fileInput" />
    <button onclick="handleFileUploadAndProcess()">Start</button>
  </body>
</html>
